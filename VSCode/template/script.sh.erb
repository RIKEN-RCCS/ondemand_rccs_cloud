<%
  require_relative "/var/www/ood/apps/sys/oodjp_apps/utils/config.rb"
  XDG_DATA_HOME, CONTAINER_IMAGE = load_app_config
%>
#!/usr/bin/env bash

# set SINGULARITY_BINDPATH and _OPTION
<%= set_bindpath %>
export SINGULARITY_BINDPATH=${SINGULARITY_BINDPATH},/cloud_opt,/lvs0,/hs

# select image and create a directory for extensions
if [ `arch` = "x86_64" ]; then
  CONTAINER_IMAGE=<%= CONTAINER_IMAGE["x86_64"] %>
  CODE_SERVER_DATAROOT=<%= XDG_DATA_HOME["x86_64"] %>/VSCode
else
  CODE_SERVER_DATAROOT=<%= XDG_DATA_HOME["aarch64"] %>/VSCode
  if [ "<%= context.global_queue %>" = "fx700" ]; then
    CONTAINER_IMAGE="/cloud_opt/ondemand/rocky97_fx700_aarch64.sif"
  else
    CONTAINER_IMAGE=<%= CONTAINER_IMAGE["aarch64"] %>
  fi
fi

mkdir -p ${CODE_SERVER_DATAROOT}/extensions

cd "${HOME}"
export LANG=C

# Expose the password to the server.
export PASSWORD="$password"

singularity run --env PS1='\u@\h:\w\$ ' ${_OPTION} ${CONTAINER_IMAGE} code-server \
  --auth="password" \
  --bind-addr="0.0.0.0:${port}" \
  --disable-telemetry \
  --user-data-dir="$CODE_SERVER_DATAROOT" \
  --extensions-dir="$CODE_SERVER_DATAROOT/extensions" \
  --log debug --disable-update-check
